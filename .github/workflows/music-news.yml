name: Music News Automation with Claude AI

#on:
#  schedule:
#    - cron: '0 1 * * *'  # Îß§Ïùº ÌïúÍµ≠ÏãúÍ∞Ñ Ïò§Ï†Ñ 10Ïãú (UTC Ïò§Ï†Ñ 1Ïãú)
workflow_dispatch: # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  run-music-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Verify required files
      run: |
        echo "üìÅ Checking required files..."
        required_files=(
          "music_news_automation.py" 
          "advanced_news_collector.py" 
          "advanced_classifier.py" 
          "ai_summarizer.py"
          "news_delivery_system.py" 
          "json_generator.py" 
          "requirements.txt"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file found"
          else
            echo "‚ùå $file missing"
            exit 1
          fi
        done
        echo "‚úÖ All required files found"
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing Python packages..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "‚úÖ Dependencies installed successfully"
    
    - name: Test Python imports
      run: |
        echo "üîç Testing Python module imports..."
        python -c "
        try:
            print('Testing advanced_news_collector...')
            from advanced_news_collector import AdvancedNewsCollector
            print('‚úÖ advanced_news_collector imported')
            
            print('Testing ai_summarizer...')
            from ai_summarizer import AISummarizer
            print('‚úÖ ai_summarizer imported')
            
            print('Testing advanced_classifier...')
            from advanced_classifier import AdvancedClassifier
            print('‚úÖ advanced_classifier imported')
            
            print('Testing news_delivery_system...')
            from news_delivery_system import NewsDeliverySystem
            print('‚úÖ news_delivery_system imported')
            
            print('Testing json_generator...')
            from json_generator import MusicNewsJSONGenerator
            print('‚úÖ json_generator imported')
            
            print('Testing music_news_automation main function...')
            from music_news_automation import main
            print('‚úÖ music_news_automation main function imported')
            
            print('üéâ All imports successful!')
            
        except Exception as e:
            print(f'‚ùå Import error: {e}')
            exit(1)
        "
    
    - name: Test Claude API connection
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ü§ñ Testing Claude API connection..."
        
        python -c "
        import os
        import sys
        
        try:
            from ai_summarizer import AISummarizer
            
            # API ÌÇ§ ÌôïÏù∏
            api_key = os.environ.get('ANTHROPIC_API_KEY')
            if not api_key:
                print('‚ùå ANTHROPIC_API_KEY not found')
                sys.exit(1)
            
            print(f'‚úÖ API key found (length: {len(api_key)})')
            
            # AI ÏöîÏïΩÍ∏∞ Ï¥àÍ∏∞Ìôî ÌÖåÏä§Ìä∏
            summarizer = AISummarizer()
            print('‚úÖ AI summarizer initialized successfully')
            
            # Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ ÏöîÏïΩ
            test_summary = summarizer.generate_summary(
                'Test Music News', 
                'This is a test description for music news.',
                'https://example.com'
            )
            print(f'‚úÖ Test summary generated: {test_summary[:50]}...')
            print('üéâ Claude API connection successful!')
            
        except Exception as e:
            print(f'‚ùå Claude API test failed: {e}')
            print('üí° Will fall back to rule-based summaries')
            # AI Ïã§Ìå® ÏãúÏóêÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
        " || echo "‚ö†Ô∏è Claude API test failed, continuing with fallback"
    
    - name: Verify environment variables
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
        GMAIL_USER: ${{ secrets.EMAIL_ADDRESS }}
        GMAIL_APP_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.EMAIL_ADDRESS }}
      run: |
        echo "üîê Verifying environment variables..."
        
        # Claude API ÌÇ§ ÌôïÏù∏
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "‚ö†Ô∏è  ANTHROPIC_API_KEY not set"
          echo "üí° Please add ANTHROPIC_API_KEY to GitHub Secrets"
          echo "üîÑ Will use rule-based summaries instead"
        else
          echo "‚úÖ ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
        fi
        
        # Slack ÌÜ†ÌÅ∞ ÌôïÏù∏
        if [ -z "$SLACK_BOT_TOKEN" ]; then
          echo "‚ùå SLACK_BOT_TOKEN not set"
          echo "üí° Please add SLACK_TOKEN to GitHub Secrets"
          exit 1
        else
          echo "‚úÖ SLACK_BOT_TOKEN is set (length: ${#SLACK_BOT_TOKEN})"
        fi
        
        # Gmail ÏÑ§Ï†ï ÌôïÏù∏
        if [ -z "$GMAIL_USER" ]; then
          echo "‚ùå GMAIL_USER not set"
          echo "üí° Please add EMAIL_ADDRESS to GitHub Secrets"
          exit 1
        else
          echo "‚úÖ GMAIL_USER is set: $GMAIL_USER"
        fi
        
        if [ -z "$GMAIL_APP_PASSWORD" ]; then
          echo "‚ùå GMAIL_APP_PASSWORD not set"
          echo "üí° Please add EMAIL_PASSWORD to GitHub Secrets"
          exit 1
        else
          echo "‚úÖ GMAIL_APP_PASSWORD is set (length: ${#GMAIL_APP_PASSWORD})"
        fi
        
        echo "‚úÖ Environment variables verification completed"
    
    - name: Run music news automation with AI
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
        SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
        GMAIL_USER: ${{ secrets.EMAIL_ADDRESS }}
        GMAIL_APP_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.EMAIL_ADDRESS }}
        SLACK_CHANNEL_ID: C08RABUFRD0
      run: |
        echo "üéµ Starting music news automation with Claude AI..."
        echo "üìÖ Execution time: $(date)"
        echo "ü§ñ AI Summary: $([ -n "$ANTHROPIC_API_KEY" ] && echo "Enabled" || echo "Disabled")"
        
        # ÌîÑÎ°úÎçïÏÖò Î™®ÎìúÎ°ú Ïã§Ìñâ
        python music_news_automation.py --production
        
        echo "‚úÖ Music news automation completed successfully"
        echo "üìÖ Completion time: $(date)"
    
    - name: Verify JSON files and check AI usage
      run: |
        echo "üìÑ Checking generated JSON files..."
        
        if [ -f "music_news.json" ]; then
          echo "‚úÖ music_news.json generated"
          echo "üìä File size: $(du -h music_news.json | cut -f1)"
          
          # AI ÏöîÏïΩ ÏÇ¨Ïö© ÌòÑÌô© ÌôïÏù∏
          AI_STATS=$(python -c "
          import json
          
          try:
              with open('music_news.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              news_items = data.get('news', [])
              ai_count = sum(1 for item in news_items if item.get('summary_type') == 'ai_generated')
              rule_count = sum(1 for item in news_items if item.get('summary_type') == 'rule_based')
              total_count = len(news_items)
              
              print(f'{ai_count},{rule_count},{total_count}')
              
          except Exception as e:
              print('0,0,0')
          " 2>/dev/null || echo "0,0,0")
          
          IFS=',' read -r AI_COUNT RULE_COUNT TOTAL_COUNT <<< "$AI_STATS"
          
          echo "ü§ñ AI ÏöîÏïΩ: $AI_COUNT Í∞ú"
          echo "üìù Í∑úÏπô Í∏∞Î∞ò ÏöîÏïΩ: $RULE_COUNT Í∞ú"
          echo "üìä Ï†ÑÏ≤¥ Îâ¥Ïä§: $TOTAL_COUNT Í∞ú"
          
          echo "üìã JSON Preview:"
          head -20 music_news.json
        else
          echo "‚ùå music_news.json not found"
          exit 1
        fi
        
        # Îã§Î•∏ ÌååÏùºÎì§ ÌôïÏù∏ (Ïã§Ìå®Ìï¥ÎèÑ Í≤ΩÍ≥†Îßå)
        if [ -f "api_info.json" ]; then
          echo "‚úÖ api_info.json generated"
        else
          echo "‚ö†Ô∏è api_info.json not found"
        fi
        
        if [ -f "README.md" ]; then
          echo "‚úÖ README.md generated"
        else
          echo "‚ö†Ô∏è README.md not found"
        fi
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push JSON files
      run: |
        echo "üì§ Committing generated files to repository..."
        
        # Î≥ÄÍ≤ΩÏÇ¨Ìï≠ ÌôïÏù∏ (archive Ìè¥ÎçîÍ∞Ä ÏóÜÏñ¥ÎèÑ Ïò§Î•ò ÏóÜÍ≤å)
        git add music_news.json api_info.json README.md
        if [ -d "archive" ]; then
          git add archive/
        fi
        
        # Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if git diff --staged --quiet; then
          echo "üìù No changes to commit"
        else
          # Ïª§Î∞ã Î©îÏãúÏßÄÏóê ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Î∞è AI ÏÇ¨Ïö© Ïó¨Î∂Ä Ìè¨Ìï®
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          # AI ÏÇ¨Ïö© ÌòÑÌô© ÌôïÏù∏
          AI_STATUS=$(python -c "
          import json
          
          try:
              with open('music_news.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              news_items = data.get('news', [])
              ai_count = sum(1 for item in news_items if item.get('summary_type') == 'ai_generated')
              rule_count = sum(1 for item in news_items if item.get('summary_type') == 'rule_based')
              
              print(f'AI:{ai_count}, Rule:{rule_count}')
              
          except Exception:
              print('Status check failed')
          " 2>/dev/null || echo "Status unavailable")
          
          git commit -m "üéµ Update music news data with Claude AI - $TIMESTAMP

          - Generated latest music news JSON
          - Summary generation: $AI_STATUS
          - Updated API information
          - Refreshed documentation
          
          Auto-generated by GitHub Actions with Claude AI integration"
          
          # Ìë∏Ïãú
          git push
          
          echo "‚úÖ Successfully committed and pushed JSON files"
          echo "üåê JSON API URL: https://raw.githubusercontent.com/${{ github.repository }}/main/music_news.json"
        fi
    
    - name: Create deployment summary
      run: |
        echo "üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "===================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üéµ **Music News API Updated with Claude AI**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìÖ **Generated at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üîó **API Endpoints:**" >> $GITHUB_STEP_SUMMARY
        echo "- Latest News: \`https://raw.githubusercontent.com/${{ github.repository }}/main/music_news.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- API Info: \`https://raw.githubusercontent.com/${{ github.repository }}/main/api_info.json\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "music_news.json" ]; then
          # ÌÜµÍ≥Ñ Ï†ïÎ≥¥ ÏàòÏßë
          STATS=$(python -c "
          import json
          
          try:
              with open('music_news.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              # Í∏∞Î≥∏ ÌÜµÍ≥Ñ
              total_news = data.get('metadata', {}).get('total_news', 0)
              news_items = data.get('news', [])
              
              # AI ÏöîÏïΩ ÌÜµÍ≥Ñ
              ai_count = sum(1 for item in news_items if item.get('summary_type') == 'ai_generated')
              rule_count = sum(1 for item in news_items if item.get('summary_type') == 'rule_based')
              total_items = len(news_items)
              
              if total_items > 0:
                  ai_percentage = (ai_count / total_items * 100)
                  ai_summary = f'{ai_count}/{total_items} ({ai_percentage:.1f}% AI)'
              else:
                  ai_summary = 'N/A'
              
              print(f'{total_news},{ai_summary}')
              
          except Exception as e:
              print('0,Error')
          " 2>/dev/null || echo "0,Error")
          
          IFS=',' read -r TOTAL_NEWS AI_SUMMARY <<< "$STATS"
          
          echo "üìä **Statistics:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total News: $TOTAL_NEWS" >> $GITHUB_STEP_SUMMARY
          echo "- AI Summaries: $AI_SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "- Categories: NEWS, REPORT, INSIGHT, INTERVIEW, COLUMN" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ü§ñ **AI Integration:** Claude-3-Haiku (Top 10 news items)" >> $GITHUB_STEP_SUMMARY
        echo "üìù **Fallback:** Rule-based 5W1H summaries" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ **Status:** Successfully updated" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload logs and artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
          music_news.json
          api_info.json
          README.md
        retention-days: 7
        if-no-files-found: warn
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Workflow execution failed"
        echo "üìÖ Failed at: $(date)"
        echo "üí° Check the logs above for detailed error information"
        echo "üîß Common solutions:"
        echo "   1. Verify GitHub Secrets are set correctly"
        echo "   2. Check ANTHROPIC_API_KEY is valid and has credits"
        echo "   3. Ensure all required files are uploaded"
        echo "   4. Verify Slack bot has proper permissions"
        echo "   5. Check Gmail app password is correct"
        echo "   6. AI errors will fallback to rule-based summaries"
