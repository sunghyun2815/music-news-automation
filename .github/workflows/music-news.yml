name: Music News Automation with Claude AI

on:
  schedule:
    - cron: '0 1 * * *'  # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 10ì‹œ (UTC ì˜¤ì „ 1ì‹œ)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  run-music-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Verify required files
      run: |
        echo "ğŸ“ Checking required files..."
        required_files=(
          "music_news_automation.py" 
          "advanced_news_collector.py" 
          "advanced_classifier.py" 
          "ai_summarizer.py"
          "news_delivery_system.py" 
          "json_generator.py" 
          "requirements.txt"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file found"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        echo "âœ… All required files found"
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing Python packages..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed successfully"
    
    - name: Test Python imports
      run: |
        echo "ğŸ” Testing Python module imports..."
        python -c "
        try:
            print('Testing advanced_news_collector...')
            from advanced_news_collector import AdvancedNewsCollector
            print('âœ… advanced_news_collector imported')
            
            print('Testing ai_summarizer...')
            from ai_summarizer import AISummarizer
            print('âœ… ai_summarizer imported')
            
            print('Testing advanced_classifier...')
            from advanced_classifier import AdvancedClassifier
            print('âœ… advanced_classifier imported')
            
            print('Testing news_delivery_system...')
            from news_delivery_system import NewsDeliverySystem
            print('âœ… news_delivery_system imported')
            
            print('Testing json_generator...')
            from json_generator import MusicNewsJSONGenerator
            print('âœ… json_generator imported')
            
            print('Testing music_news_automation main function...')
            from music_news_automation import main
            print('âœ… music_news_automation main function imported')
            
            print('ğŸ‰ All imports successful!')
            
        except Exception as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
    
    - name: Test Claude API connection
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "ğŸ¤– Testing Claude API connection..."
        python -c "
        import os
        from ai_summarizer import AISummarizer
        
        try:
            # API í‚¤ í™•ì¸
            api_key = os.environ.get('ANTHROPIC_API_KEY')
            if not api_key:
                print('âŒ ANTHROPIC_API_KEY not found')
                exit(1)
            
            print(f'âœ… API key found (length: {len(api_key)})')
            
            # AI ìš”ì•½ê¸° ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
            summarizer = AISummarizer()
            print('âœ… AI summarizer initialized successfully')
            
            # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì•½
            test_summary = summarizer.generate_summary(
                'Test Music News', 
                'This is a test description for music news.',
                'https://example.com'
            )
            print(f'âœ… Test summary generated: {test_summary[:50]}...')
            
        except Exception as e:
            print(f'âŒ Claude API test failed: {e}')
            print('ğŸ’¡ Falling back to rule-based summaries')
            # AI ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì§„í–‰ (ê·œì¹™ ê¸°ë°˜ ìš”ì•½ ì‚¬ìš©)
        "
    
    - name: Verify environment variables
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
        GMAIL_USER: ${{ secrets.EMAIL_ADDRESS }}
        GMAIL_APP_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.EMAIL_ADDRESS }}
      run: |
        echo "ğŸ” Verifying environment variables..."
        
        # Claude API í‚¤ í™•ì¸
        if [ -z "$ANTHROPIC_API_KEY" ]; then
          echo "âš ï¸  ANTHROPIC_API_KEY not set"
          echo "ğŸ’¡ Please add ANTHROPIC_API_KEY to GitHub Secrets"
          echo "ğŸ”„ Will use rule-based summaries instead"
        else
          echo "âœ… ANTHROPIC_API_KEY is set (length: ${#ANTHROPIC_API_KEY})"
        fi
        
        # Slack í† í° í™•ì¸
        if [ -z "$SLACK_BOT_TOKEN" ]; then
          echo "âŒ SLACK_BOT_TOKEN not set"
          echo "ğŸ’¡ Please add SLACK_TOKEN to GitHub Secrets"
          exit 1
        else
          echo "âœ… SLACK_BOT_TOKEN is set (length: ${#SLACK_BOT_TOKEN})"
        fi
        
        # Gmail ì„¤ì • í™•ì¸
        if [ -z "$GMAIL_USER" ]; then
          echo "âŒ GMAIL_USER not set"
          echo "ğŸ’¡ Please add EMAIL_ADDRESS to GitHub Secrets"
          exit 1
        else
          echo "âœ… GMAIL_USER is set: $GMAIL_USER"
        fi
        
        if [ -z "$GMAIL_APP_PASSWORD" ]; then
          echo "âŒ GMAIL_APP_PASSWORD not set"
          echo "ğŸ’¡ Please add EMAIL_PASSWORD to GitHub Secrets"
          exit 1
        else
          echo "âœ… GMAIL_APP_PASSWORD is set (length: ${#GMAIL_APP_PASSWORD})"
        fi
        
        echo "âœ… Environment variables verification completed"
    
    - name: Run music news automation with AI
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
        SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
        GMAIL_USER: ${{ secrets.EMAIL_ADDRESS }}
        GMAIL_APP_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.EMAIL_ADDRESS }}
        SLACK_CHANNEL_ID: C08RABUFRD0
      run: |
        echo "ğŸµ Starting music news automation with Claude AI..."
        echo "ğŸ“… Execution time: $(date)"
        echo "ğŸ¤– AI Summary: $([ -n "$ANTHROPIC_API_KEY" ] && echo "Enabled" || echo "Disabled")"
        
        # í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰
        python music_news_automation.py --production
        
        echo "âœ… Music news automation completed successfully"
        echo "ğŸ“… Completion time: $(date)"
    
    - name: Verify JSON files and check AI usage
      run: |
        echo "ğŸ“„ Checking generated JSON files..."
        
        if [ -f "music_news.json" ]; then
          echo "âœ… music_news.json generated"
          echo "ğŸ“Š File size: $(du -h music_news.json | cut -f1)"
          
          # AI ìš”ì•½ ì‚¬ìš© í˜„í™© í™•ì¸
          AI_COUNT=$(python -c "
          import json
          try:
              with open('music_news.json', 'r') as f:
                  data = json.load(f)
              ai_count = sum(1 for item in data.get('news', []) if item.get('summary_type') == 'ai_generated')
              rule_count = sum(1 for item in data.get('news', []) if item.get('summary_type') == 'rule_based')
              print(f'AI:{ai_count},Rule:{rule_count}')
          except Exception as e:
              print('Error:0,0')
          ")
          
          IFS=',' read -r AI_PART RULE_PART <<< "$AI_COUNT"
          AI_NUM=$(echo $AI_PART | cut -d':' -f2)
          RULE_NUM=$(echo $RULE_PART | cut -d':' -f2)
          
          echo "ğŸ¤– AI ìš”ì•½: $AI_NUM ê°œ"
          echo "ğŸ“ ê·œì¹™ ê¸°ë°˜ ìš”ì•½: $RULE_NUM ê°œ"
          
          echo "ğŸ“‹ Preview:"
          head -20 music_news.json
        else
          echo "âŒ music_news.json not found"
          exit 1
        fi
        
        if [ -f "api_info.json" ]; then
          echo "âœ… api_info.json generated"
        else
          echo "âŒ api_info.json not found"
          exit 1
        fi
        
        if [ -f "README.md" ]; then
          echo "âœ… README.md generated"
        else
          echo "âŒ README.md not found"
          exit 1
        fi
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push JSON files
      run: |
        echo "ğŸ“¤ Committing generated files to repository..."
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        git add music_news.json api_info.json README.md archive/
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --staged --quiet; then
          echo "ğŸ“ No changes to commit"
        else
          # ì»¤ë°‹ ë©”ì‹œì§€ì— íƒ€ì„ìŠ¤íƒ¬í”„ ë° AI ì‚¬ìš© ì—¬ë¶€ í¬í•¨
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          # AI ì‚¬ìš© í˜„í™© í™•ì¸
          AI_STATUS="Unknown"
          if [ -f "music_news.json" ]; then
            AI_STATUS=$(python -c "
            import json
            try:
                with open('music_news.json', 'r') as f:
                    data = json.load(f)
                ai_count = sum(1 for item in data.get('news', []) if item.get('summary_type') == 'ai_generated')
                rule_count = sum(1 for item in data.get('news', []) if item.get('summary_type') == 'rule_based')
                print(f'AI:{ai_count}, Rule:{rule_count}')
            except:
                print('Status check failed')
            ")
          fi
          
          git commit -m "ğŸµ Update music news data with AI - $TIMESTAMP

          - Generated latest music news JSON
          - Summary generation: $AI_STATUS
          - Updated API information
          - Refreshed documentation
          
          Auto-generated by GitHub Actions with Claude AI integration"
          
          # í‘¸ì‹œ
          git push
          
          echo "âœ… Successfully committed and pushed JSON files"
          echo "ğŸŒ JSON API URL: https://raw.githubusercontent.com/${{ github.repository }}/main/music_news.json"
        fi
    
    - name: Create deployment summary
      run: |
        echo "ğŸ“Š Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "===================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸµ **Music News API Updated with AI**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **Generated at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **API Endpoints:**" >> $GITHUB_STEP_SUMMARY
        echo "- Latest News: \`https://raw.githubusercontent.com/${{ github.repository }}/main/music_news.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- API Info: \`https://raw.githubusercontent.com/${{ github.repository }}/main/api_info.json\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "music_news.json" ]; then
          NEWS_COUNT=$(python -c "import json; data=json.load(open('music_news.json')); print(data['metadata']['total_news'])")
          
          # AI ì‚¬ìš© í˜„í™© í™•ì¸
          AI_SUMMARY=$(python -c "
          import json
          try:
              with open('music_news.json', 'r') as f:
                  data = json.load(f)
              ai_count = sum(1 for item in data.get('news', []) if item.get('summary_type') == 'ai_generated')
              rule_count = sum(1 for item in data.get('news', []) if item.get('summary_type') == 'rule_based')
              total = ai_count + rule_count
              ai_percentage = (ai_count / total * 100) if total > 0 else 0
              print(f'{ai_count}/{total} ({ai_percentage:.1f}% AI)')
          except:
              print('N/A')
          ")
          
          echo "ğŸ“Š **Statistics:**" >> $GITHUB_STEP_SUMMARY
          echo "- Total News: $NEWS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- AI Summaries: $AI_SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "- Categories: NEWS, REPORT, INSIGHT, INTERVIEW, COLUMN" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¤– **AI Integration:** Claude-3-Haiku (Top 10 news items)" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ **Fallback:** Rule-based 5W1H summaries" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status:** Successfully updated" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload logs and artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
          music_news.json
          api_info.json
          README.md
        retention-days: 7
        if-no-files-found: warn
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Workflow execution failed"
        echo "ğŸ“… Failed at: $(date)"
        echo "ğŸ’¡ Check the logs above for detailed error information"
        echo "ğŸ”§ Common solutions:"
        echo "   1. Verify GitHub Secrets are set correctly"
        echo "   2. Check ANTHROPIC_API_KEY is valid and has credits"
        echo "   3. Ensure all required files are uploaded"
        echo "   4. Verify Slack bot has proper permissions"
        echo "   5. Check Gmail app password is correct"
        echo "   6. AI errors will fallback to rule-based summaries"
