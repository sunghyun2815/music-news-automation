name: Music News Automation

on:
  schedule:
    - cron: '0 1 * * *'  # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 10ì‹œ (UTC ì˜¤ì „ 1ì‹œ)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  run-music-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 30ë¶„ íƒ€ì„ì•„ì›ƒ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'  # pip ìºì‹œ í™œìš©ìœ¼ë¡œ ì†ë„ í–¥ìƒ
    
    - name: Verify required files
      run: |
        echo "ğŸ“ Checking required files..."
        required_files=("music_news_automation.py" "advanced_news_collector.py" "advanced_classifier.py" "news_delivery_system.py" "requirements.txt")
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file found"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        echo "âœ… All required files found"
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing Python packages..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "âœ… Dependencies installed successfully"
    
    - name: Test Python imports
      run: |
        echo "ğŸ” Testing Python module imports..."
        python -c "
        try:
            print('Testing advanced_news_collector...')
            from advanced_news_collector import AdvancedNewsCollector
            print('âœ… advanced_news_collector imported')
            
            print('Testing advanced_classifier...')
            from advanced_classifier import AdvancedClassifier
            print('âœ… advanced_classifier imported')
            
            print('Testing news_delivery_system...')
            from news_delivery_system import NewsDeliverySystem
            print('âœ… news_delivery_system imported')
            
            print('Testing music_news_automation...')
            from music_news_automation import MusicNewsAutomationSystem
            print('âœ… music_news_automation imported')
            
            print('ğŸ‰ All imports successful!')
            
        except Exception as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
    
    - name: Verify environment variables
      env:
        SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        echo "ğŸ” Verifying environment variables..."
        
        if [ -z "$SLACK_TOKEN" ]; then
          echo "âŒ SLACK_TOKEN not set"
          echo "ğŸ’¡ Please add SLACK_TOKEN to GitHub Secrets"
          exit 1
        else
          echo "âœ… SLACK_TOKEN is set (length: ${#SLACK_TOKEN})"
        fi
        
        if [ -z "$EMAIL_ADDRESS" ]; then
          echo "âŒ EMAIL_ADDRESS not set"
          echo "ğŸ’¡ Please add EMAIL_ADDRESS to GitHub Secrets"
          exit 1
        else
          echo "âœ… EMAIL_ADDRESS is set: $EMAIL_ADDRESS"
        fi
        
        if [ -z "$EMAIL_PASSWORD" ]; then
          echo "âŒ EMAIL_PASSWORD not set"
          echo "ğŸ’¡ Please add EMAIL_PASSWORD to GitHub Secrets"
          exit 1
        else
          echo "âœ… EMAIL_PASSWORD is set (length: ${#EMAIL_PASSWORD})"
        fi
        
        echo "âœ… All environment variables verified"
    
    - name: Run music news automation
      env:
        SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
        EMAIL_ADDRESS: ${{ secrets.EMAIL_ADDRESS }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        echo "ğŸµ Starting music news automation system..."
        echo "ğŸ“… Execution time: $(date)"
        
        python music_news_automation.py --production
        
        echo "âœ… Music news automation completed successfully"
        echo "ğŸ“… Completion time: $(date)"
    
    - name: Upload logs and artifacts
      if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 7
        if-no-files-found: warn
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Workflow execution failed"
        echo "ğŸ“… Failed at: $(date)"
        echo "ğŸ’¡ Check the logs above for detailed error information"
        echo "ğŸ”§ Common solutions:"
        echo "   1. Verify GitHub Secrets are set correctly"
        echo "   2. Check if all required files are uploaded"
        echo "   3. Ensure Slack bot has proper permissions"
        echo "   4. Verify Gmail app password is correct"

